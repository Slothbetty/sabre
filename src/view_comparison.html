<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buffer.py Comparison Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .file-input-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .file-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        input[type="file"] {
            padding: 8px;
            border: 2px dashed #ddd;
            border-radius: 4px;
            cursor: pointer;
            flex: 1;
            min-width: 200px;
        }
        
        button {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .summary-card h3 {
            color: #7f8c8d;
            font-size: 14px;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        
        .summary-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .summary-card .comparison {
            font-size: 14px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        
        .comparison.positive {
            color: #27ae60;
        }
        
        .comparison.negative {
            color: #e74c3c;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .chart-container h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .chart-wrapper {
            position: relative;
            height: 400px;
        }
        
        .error-message {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .config-info {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .config-info strong {
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Buffer.py Comparison Viewer</h1>
            <p>Compare simulation results with and without dynamic buffering</p>
        </header>
        
        <div class="file-input-section">
            <div class="file-input-wrapper">
                <input type="file" id="jsonFileInput" accept=".json">
                <button onclick="loadFile()">Load Comparison Data</button>
                <button onclick="loadExample()">Load Example</button>
            </div>
        </div>
        
        <div id="errorMessage" class="error-message" style="display: none;"></div>
        <div id="loadingMessage" class="loading" style="display: none;">Loading data...</div>
        
        <div id="content" style="display: none;">
            <div id="configInfo" class="config-info"></div>
            
            <div class="summary-cards" id="summaryCards"></div>
            
            <div class="chart-container">
                <h2>Rebuffering Comparison</h2>
                <div class="chart-wrapper">
                    <canvas id="rebufferChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h2>Buffer Level Over Time</h2>
                <div class="chart-wrapper">
                    <canvas id="bufferChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h2>Quality Over Time</h2>
                <div class="chart-wrapper">
                    <canvas id="qualityChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h2>Quality Distribution</h2>
                <div class="chart-wrapper">
                    <canvas id="qualityDistChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let comparisonData = null;
        let charts = {};
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        function loadFile() {
            const fileInput = document.getElementById('jsonFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('Please select a JSON file');
                return;
            }
            
            document.getElementById('loadingMessage').style.display = 'block';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    comparisonData = JSON.parse(e.target.result);
                    renderComparison();
                } catch (error) {
                    showError('Error parsing JSON: ' + error.message);
                    document.getElementById('loadingMessage').style.display = 'none';
                }
            };
            reader.readAsText(file);
        }
        
        function loadExample() {
            comparisonData = {
                config: {
                    network: 'network.json',
                    movie: 'movie.json',
                    abr: 'bola'
                },
                without_buffer_py: {
                    summary: {
                        total_rebuffer_time: 2.5,
                        rebuffer_count: 3,
                        total_play_time: 120.0,
                        played_utility: 8.5,
                        rebuffer_ratio: 0.02
                    },
                    time_series: {
                        time_points: [0, 1, 2, 3, 4, 5],
                        buffer_levels: [0, 2, 4, 3, 5, 6],
                        qualities: [0, 1, 2, 1, 2, 3]
                    }
                },
                with_buffer_py: {
                    summary: {
                        total_rebuffer_time: 1.2,
                        rebuffer_count: 1,
                        total_play_time: 120.0,
                        played_utility: 9.2,
                        rebuffer_ratio: 0.01
                    },
                    time_series: {
                        time_points: [0, 1, 2, 3, 4, 5],
                        buffer_levels: [0, 3, 5, 4, 6, 7],
                        qualities: [0, 2, 2, 2, 3, 3]
                    }
                }
            };
            renderComparison();
        }
        
        function renderComparison() {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('content').style.display = 'block';
            
            renderConfigInfo();
            renderSummary();
            renderCharts();
        }
        
        function renderConfigInfo() {
            const config = comparisonData.config || {};
            const configHtml = `
                <strong>Configuration:</strong> 
                Network: ${config.network || 'N/A'}, 
                Movie: ${config.movie || 'N/A'}, 
                ABR: ${config.abr || 'N/A'}
                ${config.seek_config ? `, Seeks: ${config.seek_config}` : ''}
            `;
            document.getElementById('configInfo').innerHTML = configHtml;
        }
        
        function renderSummary() {
            const without = comparisonData.without_buffer_py.summary || {};
            const with_ = comparisonData.with_buffer_py.summary || {};
            
            const metrics = [
                {
                    label: 'Total Rebuffering Time',
                    key: 'total_rebuffer_time',
                    unit: 's',
                    lowerIsBetter: true
                },
                {
                    label: 'Rebuffering Events',
                    key: 'rebuffer_count',
                    unit: '',
                    lowerIsBetter: true
                },
                {
                    label: 'Played Utility',
                    key: 'played_utility',
                    unit: '',
                    lowerIsBetter: false
                },
                {
                    label: 'Rebuffer Ratio',
                    key: 'rebuffer_ratio',
                    unit: '',
                    lowerIsBetter: true
                },
                {
                    label: 'Total Play Time',
                    key: 'total_play_time',
                    unit: 's',
                    lowerIsBetter: false
                }
            ];
            
            const cardsHtml = metrics.map(metric => {
                const valWithout = without[metric.key] || 0;
                const valWith = with_[metric.key] || 0;
                const diff = valWith - valWithout;
                const percentChange = valWithout !== 0 ? ((diff / valWithout) * 100).toFixed(1) : 0;
                
                let comparisonClass = 'comparison';
                let comparisonText = '';
                if (metric.lowerIsBetter) {
                    comparisonClass += diff < 0 ? ' positive' : ' negative';
                    comparisonText = diff < 0 ? `↓ ${Math.abs(percentChange)}% improvement` : `↑ ${Math.abs(percentChange)}% worse`;
                } else {
                    comparisonClass += diff > 0 ? ' positive' : ' negative';
                    comparisonText = diff > 0 ? `↑ ${Math.abs(percentChange)}% improvement` : `↓ ${Math.abs(percentChange)}% worse`;
                }
                
                return `
                    <div class="summary-card">
                        <h3>${metric.label}</h3>
                        <div class="value">${valWith.toFixed(2)}${metric.unit}</div>
                        <div class="${comparisonClass}">
                            Without: ${valWithout.toFixed(2)}${metric.unit}<br>
                            ${comparisonText}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('summaryCards').innerHTML = cardsHtml;
        }
        
        function renderCharts() {
            const without = comparisonData.without_buffer_py;
            const with_ = comparisonData.with_buffer_py;
            
            // Destroy existing charts
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};
            
            // Rebuffering comparison chart
            const rebufferCtx = document.getElementById('rebufferChart').getContext('2d');
            charts.rebuffer = new Chart(rebufferCtx, {
                type: 'bar',
                data: {
                    labels: ['Total Rebuffering Time (s)', 'Rebuffering Events'],
                    datasets: [
                        {
                            label: 'Without buffer.py',
                            data: [
                                without.summary?.total_rebuffer_time || 0,
                                without.summary?.rebuffer_count || 0
                            ],
                            backgroundColor: 'rgba(231, 76, 60, 0.7)',
                            borderColor: 'rgba(231, 76, 60, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'With buffer.py',
                            data: [
                                with_.summary?.total_rebuffer_time || 0,
                                with_.summary?.rebuffer_count || 0
                            ],
                            backgroundColor: 'rgba(39, 174, 96, 0.7)',
                            borderColor: 'rgba(39, 174, 96, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Value'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
            
            // Buffer level over time
            const bufferCtx = document.getElementById('bufferChart').getContext('2d');
            const withoutTS = without.time_series || {};
            const withTS = with_.time_series || {};
            
            charts.buffer = new Chart(bufferCtx, {
                type: 'line',
                data: {
                    labels: withoutTS.time_points || withTS.time_points || [],
                    datasets: [
                        {
                            label: 'Without buffer.py',
                            data: withoutTS.buffer_levels || [],
                            borderColor: 'rgba(231, 76, 60, 1)',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.1,
                            pointRadius: 2
                        },
                        {
                            label: 'With buffer.py',
                            data: withTS.buffer_levels || [],
                            borderColor: 'rgba(39, 174, 96, 1)',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            tension: 0.1,
                            pointRadius: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Buffer Level (seconds)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time (seconds)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
            
            // Quality over time
            const qualityCtx = document.getElementById('qualityChart').getContext('2d');
            charts.quality = new Chart(qualityCtx, {
                type: 'line',
                data: {
                    labels: withoutTS.time_points || withTS.time_points || [],
                    datasets: [
                        {
                            label: 'Without buffer.py',
                            data: withoutTS.qualities || [],
                            borderColor: 'rgba(231, 76, 60, 1)',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.1,
                            pointRadius: 2,
                            stepped: 'after'
                        },
                        {
                            label: 'With buffer.py',
                            data: withTS.qualities || [],
                            borderColor: 'rgba(39, 174, 96, 1)',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            tension: 0.1,
                            pointRadius: 2,
                            stepped: 'after'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quality Level'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time (seconds)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
            
            // Quality distribution
            const qualityDistCtx = document.getElementById('qualityDistChart').getContext('2d');
            
            // Calculate quality distribution
            const qualityDistWithout = calculateQualityDistribution(withoutTS.qualities || []);
            const qualityDistWith = calculateQualityDistribution(withTS.qualities || []);
            
            const allQualities = [...new Set([...Object.keys(qualityDistWithout), ...Object.keys(qualityDistWith)])].map(Number).sort((a, b) => a - b);
            
            charts.qualityDist = new Chart(qualityDistCtx, {
                type: 'bar',
                data: {
                    labels: allQualities.map(q => `Quality ${q}`),
                    datasets: [
                        {
                            label: 'Without buffer.py',
                            data: allQualities.map(q => qualityDistWithout[q] || 0),
                            backgroundColor: 'rgba(231, 76, 60, 0.7)',
                            borderColor: 'rgba(231, 76, 60, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'With buffer.py',
                            data: allQualities.map(q => qualityDistWith[q] || 0),
                            backgroundColor: 'rgba(39, 174, 96, 0.7)',
                            borderColor: 'rgba(39, 174, 96, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Percentage of Time'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Quality Level'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }
        
        function calculateQualityDistribution(qualities) {
            if (qualities.length === 0) return {};
            const dist = {};
            qualities.forEach(q => {
                dist[q] = (dist[q] || 0) + 1;
            });
            const total = qualities.length;
            Object.keys(dist).forEach(q => {
                dist[q] = (dist[q] / total) * 100;
            });
            return dist;
        }
        
        // Allow drag and drop
        const fileInput = document.getElementById('jsonFileInput');
        const dropZone = document.body;
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.backgroundColor = '#e8f4f8';
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.style.backgroundColor = '';
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.backgroundColor = '';
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.json')) {
                fileInput.files = e.dataTransfer.files;
                loadFile();
            }
        });
    </script>
</body>
</html>

